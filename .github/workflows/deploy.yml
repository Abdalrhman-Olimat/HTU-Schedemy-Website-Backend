name: Build and Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: htu-schedemy-backend
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Build with Maven
        run: mvn clean verify -B
      
      - name: Run tests
        run: mvn test -B
        continue-on-error: true
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: maven-build
          path: target/*.jar
          retention-days: 5

  docker-build-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account-id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
      
      - name: Extract metadata for Docker
        id: meta
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          ECR_REGISTRY=${{ steps.account.outputs.account-id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          IMAGE_URI=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}
          echo "tags=$IMAGE_URI:latest,$IMAGE_URI:$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit-sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.account.outputs.account-id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:latest
            ${{ steps.account.outputs.account-id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.commit-sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
      
      - name: Scan Docker image for vulnerabilities
        continue-on-error: true
        run: |
          aws ecr start-image-scan \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-id imageTag=latest \
            --region ${{ env.AWS_REGION }}

  deploy:
    name: Deploy to AWS ECS
    runs-on: ubuntu-latest
    needs: docker-build-push
    environment:
      name: production
      url: ${{ steps.get-alb.outputs.alb-url }}
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get CloudFormation outputs
        id: get-alb
        run: |
          ASG_NAME=$(aws cloudformation describe-stacks \
            --stack-name htu-schedemy-application \
            --query 'Stacks[0].Outputs[?OutputKey==`AutoScalingGroupName`].OutputValue' \
            --output text)
          
          ALB_DNS=$(aws cloudformation describe-stacks \
            --stack-name htu-schedemy-application \
            --query 'Stacks[0].Outputs[?OutputKey==`ApplicationLoadBalancerDNS`].OutputValue' \
            --output text)
          
          echo "asg-name=$ASG_NAME" >> $GITHUB_OUTPUT
          echo "alb-dns=$ALB_DNS" >> $GITHUB_OUTPUT
          echo "alb-url=http://$ALB_DNS" >> $GITHUB_OUTPUT
          
          echo "ðŸš€ Deploying to ASG: $ASG_NAME"
          echo "ðŸŒ ALB DNS: $ALB_DNS"
      
      - name: Trigger Auto Scaling Group instance refresh
        id: refresh
        run: |
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ steps.get-alb.outputs.asg-name }} \
            --preferences '{"MinHealthyPercentage": 90, "InstanceWarmup": 120}' \
            --query 'InstanceRefreshId' \
            --output text)
          
          echo "refresh-id=$REFRESH_ID" >> $GITHUB_OUTPUT
          echo "âœ… Instance refresh started: $REFRESH_ID"
      
      - name: Wait for instance refresh to complete
        run: |
          echo "â³ Waiting for instance refresh to complete..."
          
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name ${{ steps.get-alb.outputs.asg-name }} \
              --instance-refresh-ids ${{ steps.refresh.outputs.refresh-id }} \
              --query 'InstanceRefreshes[0].Status' \
              --output text)
            
            echo "Current status: $STATUS (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)"
            
            if [ "$STATUS" = "Successful" ]; then
              echo "âœ… Instance refresh completed successfully!"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ]; then
              echo "âŒ Instance refresh failed with status: $STATUS"
              exit 1
            fi
            
            sleep 30
            ATTEMPT=$((ATTEMPT+1))
          done
          
          echo "âš ï¸ Instance refresh timed out after 15 minutes"
          exit 1
      
      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests against ALB..."
          ALB_URL="${{ steps.get-alb.outputs.alb-url }}"
          
          # Wait for ALB to be healthy
          echo "Waiting for application to be ready..."
          sleep 30
          
          # Test health endpoint (using /courses as per ALB config)
          MAX_ATTEMPTS=10
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $ALB_URL/courses || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed! HTTP $HTTP_CODE"
              exit 0
            fi
            
            echo "â³ Attempt $((ATTEMPT+1))/$MAX_ATTEMPTS - HTTP $HTTP_CODE"
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done
          
          echo "âŒ Smoke tests failed - application not responding"
          exit 1
      
      - name: Deployment summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**ALB URL:** ${{ steps.get-alb.outputs.alb-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Instance Refresh ID:** ${{ steps.refresh.outputs.refresh-id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Application](${{ steps.get-alb.outputs.alb-url }}/courses)" >> $GITHUB_STEP_SUMMARY
          echo "- [ECR Repository](https://console.aws.amazon.com/ecr/repositories/private/${{ env.AWS_REGION }}/${{ env.ECR_REPOSITORY }})" >> $GITHUB_STEP_SUMMARY
      
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "## âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
